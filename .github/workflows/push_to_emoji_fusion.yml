name: Push Data to Emoji Fusion

on:
  workflow_run:
    workflows: ["Update and Release Emoji Data"]
    types:
      - completed
    branches:
      - main

jobs:
  push-to-emoji-fusion:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    permissions:
      contents: write
      actions: read
    
    steps:
      - name: Checkout current repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Checkout emoji-fusion repository
        uses: actions/checkout@v4
        with:
          repository: USYDShawnTan/emoji-fusion
          # ä½¿ç”¨PAT tokenå¦‚æœæœ‰çš„è¯ï¼Œå¦åˆ™ä½¿ç”¨é»˜è®¤token
          token: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
          path: emoji-fusion

      - name: Copy emojimix_data_compact.json
        run: |
          # æ£€æŸ¥æºæ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ ! -f "data/emojimix_data_compact.json" ]; then
            echo "âŒ Source file data/emojimix_data_compact.json not found!"
            exit 1
          fi
          
          # ç¡®ä¿ç›®æ ‡ç›®å½•å­˜åœ¨
          mkdir -p emoji-fusion/data
          
          # å¤åˆ¶æ–‡ä»¶åˆ°emoji-fusionä»“åº“
          cp data/emojimix_data_compact.json emoji-fusion/data/
          echo "âœ… Successfully copied emojimix_data_compact.json to emoji-fusion/data/"

      - name: Check if file has changed
        id: check_changes
        run: |
          cd emoji-fusion
          git add data/emojimix_data_compact.json
          git diff --cached --exit-code || echo "has_changes=true" >> $GITHUB_ENV

      - name: Commit and push to emoji-fusion
        if: env.has_changes == 'true'
        run: |
          cd emoji-fusion
          git config --local user.name "github-actions[bot]"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git commit -m "ğŸ”„ Update emoji data from emojimix

          - Updated emojimix_data_compact.json from emojimix repository
          - Auto-generated by GitHub Actions workflow
          - Source: ${{ github.repository }}@${{ github.sha }}"
          git push
        env:
          # ä½¿ç”¨PAT tokenå¦‚æœæœ‰çš„è¯ï¼Œå¦åˆ™ä½¿ç”¨é»˜è®¤token
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}

      - name: Success message
        if: env.has_changes == 'true'
        run: |
          echo "âœ… Successfully pushed updated emoji data to emoji-fusion repository!"
          echo "ğŸ“ File: data/emojimix_data_compact.json"
          echo "ğŸ”— Repository: https://github.com/USYDShawnTan/emoji-fusion"

      - name: No changes message
        if: env.has_changes != 'true'
        run: |
          echo "â„¹ï¸ No changes detected in emojimix_data_compact.json"
          echo "Skipping push to emoji-fusion repository"
