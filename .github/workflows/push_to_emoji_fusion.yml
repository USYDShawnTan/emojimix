name: Push Data to Emoji Fusion

on:
  workflow_run:
    workflows: ["Update and Release Emoji Data"]
    types:
      - completed
    branches:
      - main

jobs:
  push-to-emoji-fusion:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    permissions:
      contents: write
      actions: read
    
    steps:
      - name: Checkout current repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN }}

      - name: Checkout emoji-fusion repository
        uses: actions/checkout@v4
        with:
          repository: USYDShawnTan/emoji-fusion
          token: ${{ secrets.PAT_TOKEN }}
          path: emoji-fusion

      - name: Copy emojimix_data_compact.json
        run: |
          # Ê£ÄÊü•Ê∫êÊñá‰ª∂ÊòØÂê¶Â≠òÂú®
          if [ ! -f "data/emojimix_data_compact.json" ]; then
            echo "‚ùå Source file data/emojimix_data_compact.json not found!"
            exit 1
          fi
          
          # Á°Æ‰øùÁõÆÊ†áÁõÆÂΩïÂ≠òÂú®
          mkdir -p emoji-fusion/data
          
          # Â§çÂà∂Êñá‰ª∂Âà∞emoji-fusion‰ªìÂ∫ì
          cp data/emojimix_data_compact.json emoji-fusion/data/
          echo "‚úÖ Successfully copied emojimix_data_compact.json to emoji-fusion/data/"

      - name: Check if file has changed
        id: check_changes
        run: |
          cd emoji-fusion
          git add data/emojimix_data_compact.json
          git diff --cached --exit-code || echo "has_changes=true" >> $GITHUB_ENV

      - name: Commit and push to emoji-fusion
        if: env.has_changes == 'true'
        run: |
          cd emoji-fusion
          git config --local user.name "github-actions[bot]"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git commit -m "üîÑ Update emoji data from emojimix

          - Updated emojimix_data_compact.json from emojimix repository
          - Auto-generated by GitHub Actions workflow
          - Source: ${{ github.repository }}@${{ github.sha }}"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}

      - name: Success message
        if: env.has_changes == 'true'
        run: |
          echo "‚úÖ Successfully pushed updated emoji data to emoji-fusion repository!"
          echo "üìÅ File: data/emojimix_data_compact.json"
          echo "üîó Repository: https://github.com/USYDShawnTan/emoji-fusion"

      - name: No changes message
        if: env.has_changes != 'true'
        run: |
          echo "‚ÑπÔ∏è No changes detected in emojimix_data_compact.json"
          echo "Skipping push to emoji-fusion repository"
